# 规则介绍

![规则](https://img14.360buyimg.com/img/jfs/t1/194705/40/39685/62565/655478d2F0e4d89c6/0a1faf90c8d931ea.png)

## `包体积`

### `未使用的类`
定义了类没有被使用到，包含`ObjC`类和`Swift`类。
##### 扫描规则
- 没有查到到对应的`ObjC`类被引用
- 没有被当做父类使用
- 没有使用的字符串和类名一致
- 没有被当做属性类型使用
- 没有被创建或调用方法
- 没有实现`+load`方法
##### 可选的修复方式
- 移除未使用的类
- `Swift`类如果只是用了`static`方法考虑修改成`Enum`类型
- 如果只是在类型转换时使用了也会检测出是未使用的类，例如`(ABCClass *)object;`。建议检查是否真的有没有到相关类后删除
- 对于`ObjC`，如果只是作为方法参数类型使用也会被检测出是未使用的类。建议删除相关方法即可。

> 提示：删除类相对是一种安全的行为，因为删除后如果有被使用到会产生编译时错误。虽然有做字符串调用的扫描过滤，不过还是建议检查是否可能被`Runtime`动态创建调用

### `未使用的ObjC协议`
定义了`ObjC`协议没有被类使用
##### 扫描规则
- 对应的协议没有被类引用
##### 可选的修复方式
- 移除未使用的协议

### `Bundle内多Scale图片`
`Bundle`内同一张图片包含多个`Scale`会导致更大的包体积。
##### 扫描规则
- 同一个`Bundle`内存在同名但是`scale`不同的图片。例如`a@2x.png`/`a@3x.png`
##### 可选的修复方式
- 移除`Scale`更低的图片

### `大资源`
文件大小超过一定大小的即为大资源，默认为`20KB`。
##### 扫描规则
- 某个文件超过设置的大资源限额
##### 可选的修复方式
- 移除资源动态下发
- 使用更小的数据格式，例如使用更小的图片格式

### `重复的资源文件`
存在多个同样的重复文件。
#### 扫描规则
- 多个文件`MD5`一致即判定为重复文件。
##### 可选的修复方式
- 移除多余的文件

### `未使用的类Property属性`
`ObjC`类中定义的属性没有被使用到。
##### 扫描规则
- 对应的属性没有被调用 set/get 方法，同时也没有被`_`的方式使用
- 不是来自实现协议的属性
- 不是来自`Category`的属性
- 不存在字符串使用和属性名一致
- 属性是类对象类型。过滤了`基础类型`
##### 可选的修复方式
- 移除对应的属性
- 如果是接口协议的属性，需要添加类实现此接口
##### `注意事项`
- 可能存在部分动态使用的场景，需要进行一定的检查。例如一些继承`NSObject`的数据模型类，可能存在属性没有被直接使用到，但是可能会被传唤成`JSON`作为参数的情况。例如后台下发的数据模型

### `未使用的ImageSet/DataSet`
包含的`Imageset`/`DataSet`并没有被使用到。
##### 扫描规则
- 未检测到和`Imageset`同样名字的字符串使用
##### 可选的修复方式
- 移除ImageSet/DataSet
##### `注意事项`
- 某些`Swift`代码中使用的字符串不能被发现所以不能正确扫描出来。
- 使用字符串拼接的名字作为`imageset`的名字可能不能正确扫描出来。
- 被合成到`PackedAssetImage`里的`Imageset`不能正确被扫描出来。
- `xib`内使用的`Imageset`暂不支持，后续考虑支持。

### `未使用的ObjC方法`
定义的`ObjC`Category 方法并未被使用到。
##### 扫描规则
- 不存在和此方法一样的方法名使用
- 不存在使用的`字符串`和方法名一致
- 不是来自父类或`Category`的方法
- 不是来自实现接口的方法
- 不是属性 set/get 方法
##### 可选的修复方式
- 移除对应方法

### `未使用的分类方法`
定义的`ObjC`Category 方法并未被使用到。
##### 扫描规则
- 不存在和此方法一样的方法名使用
- 不存在和方法名一致的`字符串`使用
- 不是来自父类或`Category`的方法
- 不是来自实现接口的方法
##### 可选的修复方式
- 移除未使用的方法
- 如果是接口协议的方法，需要添加类实现此接口

### `未使用的资源文件`
包含的文件资源并没有被使用到。这里的资源不包含`Imageset`/`DataSet`。
##### 扫描规则
- 未检测到和文件名同样名字的字符串使用
##### 可选的修复方式
- 移除资源
##### `注意事项`
- 某些`Swift`代码中使用的字符串不能被发现所以会被当做未使用
- 使用字符串拼接的名字作为资源的名字可能不能正确扫描出来
- `xib`内使用的`资源`暂不支持，后续考虑支持。

## `安全`
### `动态反射调用ObjC类`
存在类名和字符串一致，可能使用`NSClassFromString()`方法动态调用类。当`字符串`或类名变更时无法利用编译时检查发现问题，可能会导致功能异常。
##### 扫描规则
- 存在使用的`字符串`和`NSObject子类`类名相同
##### 可选的修复方式
- 使用`NSStringFromClass()`获取类名字符串
- 使用`Framework`外部的类应该使用方法封装，除了少部分功能不应该使用反射去调用`类`
> 提示：包含继承`NSObject`的 swift 类。

### `ObjC属性内存申明错误`
一些特殊的`NSObject`类型的属性内存类型申明错误，可能会导致功能异常或触发`Crash`。
##### 扫描规则
- `NSArray`/`NSSet`/`NSDictionary`类型的属性使用`strong`申明
- `NSMutableArray`/`NSMutableSet`/`NSMutableDictionary`类型的属性使用`copy`申明
##### 可选的修复方式
- 修改`strong`/`copy`申明

### `冲突的分类方法`
`ObjC`同一个类的多个`Category`分类中存在多个相同的方法，由于运行时最终会加载方法可能是不确定的，可能会导致功能异常等未知的行为。
##### 扫描规则
- `NSObject类`的多个`Category`分类中存在多个相同的方法
##### 修复方式
- 移除多余的分类方法

### `重复的分类方法`
`ObjC`原始类和类的`Category`分类中有相同的方法，分类中的方法会覆盖原始类的方法，可能会导致功能异常等未知的行为。
##### 扫描规则
- `NSObject`原始类和类的`Category`分类中有相同的方法
##### 修复方式
- 移除重复的分类方法

### `未实现的ObjC协议方法`
类实现了某个`ObjC`协议，但是没有实现协议的`非可选`方法。可能会导致功能异常或触发`Crash`。
##### 扫描规则
- `类`和`分类`未实现`NSObject`协议的`非可选`方法
##### 可选的修复方式
- 对应的类实现缺失的`非可选`协议方法
- 将对应的协议方法标识为`optional`可选方法

### `重复的ObjC类`
多个`动态库`和`静态库`之间存在同样的`类`。不会导致编译失败，但是运行时只会使用其中一个类，可能会导致功能异常或触发`Crash`。同时会增加`包体积`。
##### 扫描规则
- 多个`动态库`和`静态库`之间存在同样的`NSObject类`符号
##### 可能的修复方式
- 移除重复的类

## `性能`
### `使用动态库`
使用动态库会增加`启动`耗时。
##### 扫描规则
- `Macho`为动态库
##### 可选的修复方式
- 使用`静态库`
- 使用`Mergeable Library`

### `实现+load方法的类`
APP`启动`后会执行所有`+load`方法，减少`+load`方法可以降低启动耗时。
##### 扫描规则
- 实现`+load`方法的`NSObject`类
##### 可选的修复方式
- 移除`+load`方法
- 使用`+initialize`替代

## `组件化工程规范`

### `Bundle 内重复资源`
不同的组件里面存在同样名字的资源，如果在同一个`Bundle`会导致某个资源丢失。
##### 扫描规则
- 同一个`Bundle`名字一样的文件或`Imageset`
##### 可选的修复方式
- 使用不同名字的`Bundle`进行管理
- 修改为不同的名字

### `未使用的子组件依赖`
组件依赖了某些子组件，但是没有使用到组件的`API`
##### 扫描规则
- 子组件被依赖但没有被使用具体的`API`
##### 可选的修复方式
- 移除对应的组件
##### `注意事项`
- 依赖组件`C`语言的宏无法被扫描出来

### `环形依赖`
组件间相互依赖，相互依赖会导致更混乱的依赖关系
##### 扫描规则
- 2个组件相互依赖
##### 可选的修复方式
- 移除组件相互依赖环

### `未使用的组件依赖`
组件被`APP`主工程依赖，但是并没有使用到组件的`API`
##### 扫描规则
- 组件没有被其他组件依赖
- 组件内不包含`+load`方法
- 不存在字符串和组件内的类名一致
##### 可选的修复方式
- 移除对应组件

## `mPaas`

### `未使用的 Router`
定义了`Router`并没有被使用
##### 扫描规则
- 所有组件都没有使用`Router`
##### 可选的修复方式
- 可考虑移除`Router`

> 提示：由于是基于字符串进行查找，使用字符串拼接的`Router`查询不出来。

### `使用未定义的 Router`
当前集成的组件没有对应的`Router`定义
##### 扫描规则
- 所有组件不存在对应的`Router`定义
##### 可选的修复方式
- 可以考虑是否需要集成对应的组件

## `考虑添加的规则`
### `未使用的 Swift 类实例方法`
### `未使用的 Swift 属性`
### `使用的 ObjC 方法未定义`
